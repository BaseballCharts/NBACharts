<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2024-25 NBA Stats Explorer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(to bottom right, #f8fafc, #dbeafe);
            min-height: 100vh;
            padding: 1rem;
        }
        #root { max-width: 1400px; margin: 0 auto; }
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: none;
            border-radius: 8px 8px 0 0;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #6b7280;
        }
        .tab.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }
        .tab:hover:not(.active) {
            background: #f3f4f6;
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .filters-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }
        h1 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            min-width: 140px;
        }
        select:focus { outline: none; border-color: #3b82f6; }
        .search-container {
            position: relative;
            min-width: 200px;
        }
        .search-input {
            width: 100%;
            padding: 0.5rem 2rem 0.5rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
        }
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .search-clear {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            padding: 0.25rem;
            font-size: 1rem;
            color: #6b7280;
            cursor: pointer;
            border: none;
        }
        .search-clear:hover {
            color: #ef4444;
        }
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-top: 0.25rem;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .search-result {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }
        .search-result:hover {
            background: #f3f4f6;
        }
        .search-result:last-child {
            border-bottom: none;
        }
        .search-result-name {
            font-weight: 600;
            color: #1f2937;
        }
        .search-result-info {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .chart-svg {
            width: 100%;
            height: 600px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fafafa;
        }
        .bubble {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .bubble:hover {
            opacity: 0.8;
        }
        .axis-line {
            stroke: #9ca3af;
            stroke-width: 2;
        }
        .axis-text {
            font-size: 12px;
            fill: #6b7280;
        }
        .axis-label {
            font-size: 14px;
            font-weight: 600;
            fill: #374151;
        }
        .grid-line {
            stroke: #e5e7eb;
            stroke-width: 1;
        }
        .tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .tooltip-player {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .source {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.75rem;
            color: #9ca3af;
        }
        button {
            padding: 0.5rem 1rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #dc2626; }
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }
        .toggle-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .toggle-container label {
            cursor: pointer;
            text-transform: none;
            font-size: 0.875rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/11wAoaz2NZsnmzGxw_kcaqDd-PbFrkf7hD6LyjKzDnhE/export?format=csv&gid=0';

        const TEAM_COLORS = {
            'ATL': '#E03A3E', 'BOS': '#007A33', 'BRK': '#000000', 'CHO': '#1D1160',
            'CHI': '#CE1141', 'CLE': '#860038', 'DAL': '#00538C', 'DEN': '#0E2240',
            'DET': '#C8102E', 'GSW': '#1D428A', 'HOU': '#CE1141', 'IND': '#002D62',
            'LAC': '#C8102E', 'LAL': '#552583', 'MEM': '#5D76A9', 'MIA': '#98002E',
            'MIL': '#00471B', 'MIN': '#0C2340', 'NOP': '#0C2340', 'NYK': '#006BB6',
            'OKC': '#007AC1', 'ORL': '#0077C0', 'PHI': '#006BB6', 'PHO': '#1D1160',
            'POR': '#E03A3E', 'SAC': '#5A2D81', 'SAS': '#C4CED4', 'TOR': '#CE1141',
            'UTA': '#002B5C', 'WAS': '#002B5C', '2TM': '#808080'
        };

        const STAT_OPTIONS = [
            { category: 'Scoring', stats: ['PPG', 'FG per Game', 'FGA per Game', 'FG%', '3P per Game', '3PA per Game', '3P%', 'FT per Game', 'FTA per Game', 'FT%', 'True Shooting %', 'Effective FG%'] },
            { category: 'Rebounds', stats: ['RPG', 'ORB per Game', 'DRB per Game', 'Total Rebound %', 'Offensive Rebound %', 'Defensive Rebound %'] },
            { category: 'Playmaking', stats: ['APG', 'Assist %', 'TOV per Game', 'Turnover %'] },
            { category: 'Defense', stats: ['SPG', 'BPG', 'Steal %', 'Block %', 'Defensive Win Shares', 'Defensive Box Plus/Minus'] },
            { category: 'Advanced', stats: ['Player Efficiency Rating (PER)', 'Win Shares', 'Win Shares per 48', 'Offensive Win Shares', 'Defensive Win Shares', 'Box Plus/Minus', 'Offensive Box Plus/Minus', 'Defensive Box Plus/Minus', 'Value Over Replacement Player (VORP)', 'Usage Rate'] },
            { category: 'General', stats: ['Games', 'MPG'] }
        ];

        function StatsChart() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('chart');
            const [xStat, setXStat] = useState('Offensive Win Shares');
            const [yStat, setYStat] = useState('Defensive Win Shares');
            const [bubbleSize, setBubbleSize] = useState('Win Shares');
            const [teamFilter, setTeamFilter] = useState('All');
            const [positionFilter, setPositionFilter] = useState('All');
            const [seasonFilter, setSeasonFilter] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');
            const [showSearchDropdown, setShowSearchDropdown] = useState(false);
            const [hoveredPlayer, setHoveredPlayer] = useState(null);
            const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
            const [highlightedPlayers, setHighlightedPlayers] = useState([]);
            const [showLabels, setShowLabels] = useState(false);

            useEffect(() => {
                Papa.parse(SHEET_URL, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        setData(results.data);
                        setLoading(false);
                    }
                });
            }, []);

            const filteredData = useMemo(() => {
                return data.filter(row => {
                    if (!row.Player) return false;
                    if (seasonFilter !== 'All' && row.Season !== seasonFilter) return false;
                    if (teamFilter !== 'All' && row.Team !== teamFilter) return false;
                    if (positionFilter !== 'All' && row.Pos !== positionFilter) return false;
                    
                    const xVal = parseFloat(row[xStat]);
                    const yVal = parseFloat(row[yStat]);
                    if (isNaN(xVal) || isNaN(yVal)) return false;
                    
                    return true;
                });
            }, [data, seasonFilter, teamFilter, positionFilter, xStat, yStat]);

            const searchResults = useMemo(() => {
                if (!searchQuery.trim()) return [];
                const query = searchQuery.toLowerCase();
                return filteredData.filter(row => 
                    row.Player.toLowerCase().includes(query)
                ).slice(0, 10);
            }, [searchQuery, filteredData]);

            const teams = useMemo(() => 
                ['All', ...new Set(data.map(d => d.Team).filter(Boolean).sort())],
                [data]
            );

            const positions = useMemo(() => 
                ['All', ...new Set(data.map(d => d.Pos).filter(Boolean).sort())],
                [data]
            );

            const seasons = useMemo(() => {
                const uniqueSeasons = [...new Set(data.map(d => d.Season).filter(Boolean))].sort();
                return ['All', ...uniqueSeasons.reverse()];
            }, [data]);

            const { xScale, yScale, xTicks, yTicks } = useMemo(() => {
                const xValues = filteredData.map(d => parseFloat(d[xStat])).filter(v => !isNaN(v));
                const yValues = filteredData.map(d => parseFloat(d[yStat])).filter(v => !isNaN(v));
                
                const xMin = Math.min(...xValues, 0);
                const xMax = Math.max(...xValues);
                const yMin = Math.min(...yValues, 0);
                const yMax = Math.max(...yValues);
                
                const padding = 0.1;
                const xRange = xMax - xMin;
                const yRange = yMax - yMin;
                
                const xDomain = [xMin - xRange * padding, xMax + xRange * padding];
                const yDomain = [yMin - yRange * padding, yMax + yRange * padding];
                
                const margin = { left: 60, right: 30, top: 30, bottom: 60 };
                const width = 1200;
                const height = 600;
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;
                
                const xScale = (val) => margin.left + ((val - xDomain[0]) / (xDomain[1] - xDomain[0])) * chartWidth;
                const yScale = (val) => height - margin.bottom - ((val - yDomain[0]) / (yDomain[1] - yDomain[0])) * chartHeight;
                
                const xTicks = Array.from({ length: 6 }, (_, i) => 
                    xDomain[0] + (xDomain[1] - xDomain[0]) * i / 5
                );
                const yTicks = Array.from({ length: 6 }, (_, i) => 
                    yDomain[0] + (yDomain[1] - yDomain[0]) * i / 5
                );
                
                return { xScale, yScale, xTicks, yTicks, margin, width, height };
            }, [filteredData, xStat, yStat]);

            const handleSearchSelect = (player) => {
                setHighlightedPlayers([player.Player]);
                setSearchQuery('');
                setShowSearchDropdown(false);
            };

            const clearSearch = () => {
                setSearchQuery('');
                setHighlightedPlayers([]);
                setShowSearchDropdown(false);
            };

            const resetFilters = () => {
                setXStat('Offensive Win Shares');
                setYStat('Defensive Win Shares');
                setBubbleSize('Win Shares');
                setTeamFilter('All');
                setPositionFilter('All');
                setSeasonFilter('All');
                setSearchQuery('');
                setHighlightedPlayers([]);
                setShowLabels(false);
            };

            const formatStatValue = (stat, value) => {
                const val = parseFloat(value);
                if (isNaN(val)) return 'N/A';
                if (stat.includes('%')) return val.toFixed(3);
                if (['Win Shares', 'Offensive Win Shares', 'Defensive Win Shares', 'Value Over Replacement Player (VORP)', 
                     'Box Plus/Minus', 'Offensive Box Plus/Minus', 'Defensive Box Plus/Minus', 
                     'Player Efficiency Rating (PER)', 'Win Shares per 48'].includes(stat)) {
                    return val.toFixed(1);
                }
                return val.toFixed(1);
            };

            const renderChartTab = () => {
                return (
                    <div className="chart-container">
                        <div className="header-row">
                            <div>
                                <h1>NBA Stats Explorer</h1>
                                <p className="subtitle">2024-25 Season (bubble size = {bubbleSize})</p>
                            </div>
                            <div className="filters-container">
                                <div className="filter-group">
                                    <label>X-Axis</label>
                                    <select value={xStat} onChange={(e) => setXStat(e.target.value)}>
                                        {STAT_OPTIONS.map(group => (
                                            <optgroup key={group.category} label={group.category}>
                                                {group.stats.map(stat => (
                                                    <option key={stat} value={stat}>{stat}</option>
                                                ))}
                                            </optgroup>
                                        ))}
                                    </select>
                                </div>
                                <div className="filter-group">
                                    <label>Y-Axis</label>
                                    <select value={yStat} onChange={(e) => setYStat(e.target.value)}>
                                        {STAT_OPTIONS.map(group => (
                                            <optgroup key={group.category} label={group.category}>
                                                {group.stats.map(stat => (
                                                    <option key={stat} value={stat}>{stat}</option>
                                                ))}
                                            </optgroup>
                                        ))}
                                    </select>
                                </div>
                                <div className="filter-group">
                                    <label>Team</label>
                                    <select value={teamFilter} onChange={(e) => setTeamFilter(e.target.value)}>
                                        {teams.map(team => (
                                            <option key={team} value={team}>{team}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="filter-group">
                                    <label>Position</label>
                                    <select value={positionFilter} onChange={(e) => setPositionFilter(e.target.value)}>
                                        {positions.map(pos => (
                                            <option key={pos} value={pos}>{pos}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="filter-group">
                                    <label>Season</label>
                                    <select value={seasonFilter} onChange={(e) => setSeasonFilter(e.target.value)}>
                                        {seasons.map(season => (
                                            <option key={season} value={season}>{season}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="filter-group">
                                    <label>Bubble Size</label>
                                    <select value={bubbleSize} onChange={(e) => setBubbleSize(e.target.value)}>
                                        {STAT_OPTIONS.map(group => (
                                            <optgroup key={group.category} label={group.category}>
                                                {group.stats.map(stat => (
                                                    <option key={stat} value={stat}>{stat}</option>
                                                ))}
                                            </optgroup>
                                        ))}
                                    </select>
                                </div>
                                <div className="filter-group">
                                    <label>Search Player</label>
                                    <div className="search-container">
                                        <input
                                            type="text"
                                            className="search-input"
                                            placeholder="Search..."
                                            value={searchQuery}
                                            onChange={(e) => {
                                                setSearchQuery(e.target.value);
                                                setShowSearchDropdown(true);
                                            }}
                                            onFocus={() => setShowSearchDropdown(true)}
                                        />
                                        {(searchQuery || highlightedPlayers.length > 0) && (
                                            <button className="search-clear" onClick={clearSearch}>×</button>
                                        )}
                                        {showSearchDropdown && searchResults.length > 0 && (
                                            <div className="search-dropdown">
                                                {searchResults.map((player, idx) => (
                                                    <div
                                                        key={idx}
                                                        className="search-result"
                                                        onClick={() => handleSearchSelect(player)}
                                                    >
                                                        <div className="search-result-name">{player.Player}</div>
                                                        <div className="search-result-info">
                                                            {player.Team} • {player.Pos} • {formatStatValue('PPG', player.PPG)} PPG
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <button onClick={resetFilters}>Reset</button>
                            </div>
                        </div>

                        <div className="toggle-container">
                            <input
                                type="checkbox"
                                id="showLabels"
                                checked={showLabels}
                                onChange={(e) => setShowLabels(e.target.checked)}
                            />
                            <label htmlFor="showLabels">Show player labels</label>
                        </div>

                        {highlightedPlayers.length > 0 && (
                            <div style={{ marginBottom: '1rem' }}>
                                <button onClick={clearSearch}>Clear Highlighted Players</button>
                            </div>
                        )}

                        <svg 
                            className="chart-svg" 
                            viewBox="0 0 1200 600"
                            onMouseMove={(e) => {
                                const rect = e.currentTarget.getBoundingClientRect();
                                setMousePos({ 
                                    x: e.clientX - rect.left, 
                                    y: e.clientY - rect.top 
                                });
                            }}
                        >
                            {/* Grid lines */}
                            {xTicks.map((tick, i) => (
                                <line
                                    key={`x-grid-${i}`}
                                    className="grid-line"
                                    x1={xScale(tick)}
                                    y1={30}
                                    x2={xScale(tick)}
                                    y2={540}
                                />
                            ))}
                            {yTicks.map((tick, i) => (
                                <line
                                    key={`y-grid-${i}`}
                                    className="grid-line"
                                    x1={60}
                                    y1={yScale(tick)}
                                    x2={1170}
                                    y2={yScale(tick)}
                                />
                            ))}

                            {/* Axes */}
                            <line className="axis-line" x1={60} y1={540} x2={1170} y2={540} />
                            <line className="axis-line" x1={60} y1={30} x2={60} y2={540} />

                            {/* X-axis ticks and labels */}
                            {xTicks.map((tick, i) => (
                                <g key={`x-tick-${i}`}>
                                    <line
                                        stroke="#9ca3af"
                                        strokeWidth={2}
                                        x1={xScale(tick)}
                                        y1={540}
                                        x2={xScale(tick)}
                                        y2={545}
                                    />
                                    <text
                                        className="axis-text"
                                        x={xScale(tick)}
                                        y={560}
                                        textAnchor="middle"
                                    >
                                        {tick.toFixed(1)}
                                    </text>
                                </g>
                            ))}

                            {/* Y-axis ticks and labels */}
                            {yTicks.map((tick, i) => (
                                <g key={`y-tick-${i}`}>
                                    <line
                                        stroke="#9ca3af"
                                        strokeWidth={2}
                                        x1={55}
                                        y1={yScale(tick)}
                                        x2={60}
                                        y2={yScale(tick)}
                                    />
                                    <text
                                        className="axis-text"
                                        x={50}
                                        y={yScale(tick) + 4}
                                        textAnchor="end"
                                    >
                                        {tick.toFixed(1)}
                                    </text>
                                </g>
                            ))}

                            {/* Axis labels */}
                            <text
                                className="axis-label"
                                x={615}
                                y={590}
                                textAnchor="middle"
                            >
                                {xStat}
                            </text>
                            <text
                                className="axis-label"
                                x={15}
                                y={285}
                                textAnchor="middle"
                                transform="rotate(-90 15 285)"
                            >
                                {yStat}
                            </text>

                            {/* Bubbles */}
                            {filteredData.map((player, i) => {
                                const x = xScale(parseFloat(player[xStat]));
                                const y = yScale(parseFloat(player[yStat]));
                                const sizeValue = parseFloat(player[bubbleSize]) || 0;
                                const radius = Math.max(3 + sizeValue * 2, 4);
                                const isHighlighted = highlightedPlayers.includes(player.Player);
                                
                                return (
                                    <g key={i}>
                                        <circle
                                            className="bubble"
                                            cx={x}
                                            cy={y}
                                            r={radius}
                                            fill="#3b82f6"
                                            fillOpacity={isHighlighted ? 1 : 0.6}
                                            stroke={isHighlighted ? '#000' : 'white'}
                                            strokeWidth={isHighlighted ? 3 : 1.5}
                                            onMouseEnter={() => setHoveredPlayer(player)}
                                            onMouseLeave={() => setHoveredPlayer(null)}
                                        />
                                        {(showLabels || isHighlighted) && (
                                            <text
                                                x={x}
                                                y={y - radius - 5}
                                                textAnchor="middle"
                                                fontSize="10"
                                                fontWeight="600"
                                                fill="#1f2937"
                                                pointerEvents="none"
                                            >
                                                {player.Player}
                                            </text>
                                        )}
                                    </g>
                                );
                            })}
                        </svg>

                        {hoveredPlayer && (
                            <div 
                                className="tooltip"
                                style={{ 
                                    left: mousePos.x + 15,
                                    top: mousePos.y - 15
                                }}
                            >
                                <div className="tooltip-player">{hoveredPlayer.Player}</div>
                                <div>Team: {hoveredPlayer.Team}</div>
                                <div>Position: {hoveredPlayer.Pos}</div>
                                <div>{bubbleSize}: {formatStatValue(bubbleSize, hoveredPlayer[bubbleSize])}</div>
                                <div>{xStat}: {formatStatValue(xStat, hoveredPlayer[xStat])}</div>
                                <div>{yStat}: {formatStatValue(yStat, hoveredPlayer[yStat])}</div>
                                <div>Games: {hoveredPlayer.Games}</div>
                            </div>
                        )}
                        
                        <div className="source">
                            Source: Basketball Reference
                        </div>
                    </div>
                );
            };

            if (loading) {
                return <div style={{ textAlign: 'center', padding: '3rem' }}>Loading data...</div>;
            }

            return (
                <div>
                    <div className="tabs">
                        <button 
                            className={`tab ${activeTab === 'chart' ? 'active' : ''}`}
                            onClick={() => setActiveTab('chart')}
                        >
                            Bubble Chart
                        </button>
                    </div>
                    
                    {renderChartTab()}
                </div>
            );
        }

        ReactDOM.render(<StatsChart />, document.getElementById('root'));
    </script>
</body>
</html>
